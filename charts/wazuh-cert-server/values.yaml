global:
  version: latest

cert:
  defaultPodOptions:
    securityContext:
      runAsUser: 1001
      runAsGroup: 1001

  controllers:
    main:
      type: deployment
      replicas: 1
      pod:
        labels:
          main: wazuh-cert-oauth2-app
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - wazuh-cert-oauth2-app
                topologyKey: "kubernetes.io/hostname"
      labels:
        main: main-app
      initContainers:
        permission-fix:
          securityContext:
            runAsUser: 0
            runAsGroup: 0
          image:
            repository: busybox
            tag: latest
            pullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              set -ex

              # Ensure the directory exists
              chown -R 1001:1001 /data
              chmod -R 775 /data
          resources:
            requests:
              cpu: 50m
              memory: 10Mi
            limits:
              cpu: 100m
              memory: 50Mi
      containers:
        app:
          image:
            repository: ghcr.io/adorsys-gis/wazuh-cert-oauth2
            tag: '{{ .Values.global.version }}'
            pullPolicy: IfNotPresent

          resources:
            requests:
              cpu: 125m
              memory: 256Mi
            limits:
              cpu: 400m
              memory: 512Mi

          # -- ConfigMap to be loaded as environment variables
          envFrom:
            - configMapRef:
                identifier: config

          env:
            RUST_LOG: 'info'
            ROCKET_ADDRESS: '0.0.0.0'

            OAUTH_ISSUER: 'http://host.docker.internal/realms/dev'

            ROOT_CA_PATH: '/usr/share/wazuh-cert-oauth2/certs/root-ca.pem'
            ROOT_CA_KEY_PATH: '/usr/share/wazuh-cert-oauth2/certs/root-ca-key.pem'
            LEDGER_PATH: '/data/ledger.csv'

            CRL_PATH: '/data/issuing.crl'
            CRL_DIST_URL: 'https://this.server.ingress/crl/issuing.crl'

  service:
    app:
      enabled: true
      annotations: { }
      type: ClusterIP
      controller: main
      ports:
        http:
          enabled: true
          port: 8100
          targetPort: 8100

  ingress:
    app:
      enabled: false
      annotations: { }
      #className: 'nginx'
      hosts:
        - host: cert.example-wazuh.adorsys.com
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: app
                port: http
      tls:
        - secretName: example-wazuh-adorsys-com-secret
          hosts:
            - cert.example-wazuh.adorsys.com

  configMaps:
    config:
      enabled: true
      annotations:
        description: 'Common configuration for the cert.'
      data:
        OTEL_EXPORTER_OTLP_ENDPOINT: 'http://alloy.collect:4317'
        OTEL_EXPORTER_OTLP_PROTOCOL: 'grpc'

  persistence:
    data:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteMany
      size: 10Gi
      storageClass: some-storage-class
      advancedMounts:
        main:
          permission-fix:
            - path: /data
          app:
            - path: /data
